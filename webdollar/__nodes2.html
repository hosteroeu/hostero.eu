<html>

<head>
  <title>WebDollar Nodes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/async/2.6.0/async.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.16/rg-1.0.2/rr-1.2.3/datatables.min.css" />
  <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.16/rg-1.0.2/rr-1.2.3/datatables.min.js"></script>
  <script type="text/javascript" src=" https://unpkg.com/simple-statistics@6.0.0/dist/simple-statistics.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>

<body>
  <div class="container">
    <br />
    <div class="alert alert-secondary" role="alert">
      SUM: <strong><span id="sum">0</span> WEBD</strong> | MEAN: <strong><span id="mean">0</span> WEBD</strong> | MEDIAN: <strong><span id="median">0</span> WEBD</strong> | ~POWER: <strong><span id="power">0</span> Kh/s</strong> | GLOBAL: <strong><span id="global_power">0</span> Kh/s</strong>      | Chance/Dominance: <strong><span id="dominance">0</span>%</strong> | ~Block Mining Time: <strong><span id="block_mining_time">0</span> s / <span id="block_mining_time_minutes">0</span> m</strong>   | Current Time: <strong><span id="current_time">00:00</span></strong> | Nodes Available: <strong><span id="nodes_available">0</span></strong> | Nodes Healthy: <strong><span id="nodes_healthy">0</span></strong> | ~Real Time: <strong><span id="real_time">0</span></strong> | X: <strong><span id="x">0</span></strong>
    </div>

    <p><i>*</i> Means hardcoded values. <i>~</i> Means estimated values. <i>Chance</i> Means probability to get reward at each block.</p>

    <p>Projections:
      <ul>
        <li>24 hour reward <strong><span id="reward_24">0</span></strong> WEBD / <strong><span id="reward_24_usd">0</span></strong> USD</li>
        <li>24 hour cost <strong><span id="cost_24_usd">0</span></strong> USD</li>
        <li>24 hour ROI <strong><span id="roi_24">0</span></strong>%</li>
      </ul>
    </p>

    <p>
      <table id="nodes" class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Hostname</th>
            <th>URL</th>
            <th>Amount</th>
            <th>Block</th>
          </tr>
        </thead>
      </table>
    </p>
  </div>

  <script type="text/javascript">
    var nodes = [{"dns":"159.89.42.26:49152","ip":"159.89.42.26","port":49152,"hostname":"ubuntu-s-2vcpu-4gb-nyc3-01"},{"dns":"159.89.42.26:65535","ip":"159.89.42.26","port":65535,"hostname":"ubuntu-s-2vcpu-4gb-nyc3-01"},{"dns":"159.89.42.26:42002","ip":"159.89.42.26","port":42002,"hostname":"ubuntu-s-2vcpu-4gb-nyc3-01"},{"dns":"159.89.42.26:57284","ip":"159.89.42.26","port":57284,"hostname":"ubuntu-s-2vcpu-4gb-nyc3-01"},{"dns":"18.217.174.14:60961","ip":"18.217.174.14","port":60961,"hostname":"ip-172-31-3-183.us-east-2.compute.internal"},{"dns":"18.217.174.14:54889","ip":"18.217.174.14","port":54889,"hostname":"ip-172-31-3-183.us-east-2.compute.internal"},{"dns":"18.217.174.14:57529","ip":"18.217.174.14","port":57529,"hostname":"ip-172-31-3-183.us-east-2.compute.internal"},{"dns":"18.217.174.14:53477","ip":"18.217.174.14","port":53477,"hostname":"ip-172-31-3-183.us-east-2.compute.internal"},{"dns":"18.191.54.44:53926","ip":"18.191.54.44","port":53926,"hostname":"ip-172-31-7-176.us-east-2.compute.internal"},{"dns":"18.191.54.44:56127","ip":"18.191.54.44","port":56127,"hostname":"ip-172-31-7-176.us-east-2.compute.internal"},{"dns":"18.191.54.44:63544","ip":"18.191.54.44","port":63544,"hostname":"ip-172-31-7-176.us-east-2.compute.internal"},{"dns":"18.191.54.44:49681","ip":"18.191.54.44","port":49681,"hostname":"ip-172-31-7-176.us-east-2.compute.internal"},{"dns":"18.216.127.136:54166","ip":"18.216.127.136","port":54166,"hostname":"ip-172-31-9-159.us-east-2.compute.internal"},{"dns":"18.216.127.136:49720","ip":"18.216.127.136","port":49720,"hostname":"ip-172-31-9-159.us-east-2.compute.internal"},{"dns":"18.216.127.136:63606","ip":"18.216.127.136","port":63606,"hostname":"ip-172-31-9-159.us-east-2.compute.internal"},{"dns":"18.216.127.136:57029","ip":"18.216.127.136","port":57029,"hostname":"ip-172-31-9-159.us-east-2.compute.internal"},{"dns":"18.188.135.104:59375","ip":"18.188.135.104","port":59375,"hostname":"ip-172-31-15-96.us-east-2.compute.internal"},{"dns":"18.188.135.104:56339","ip":"18.188.135.104","port":56339,"hostname":"ip-172-31-15-96.us-east-2.compute.internal"},{"dns":"18.188.135.104:58834","ip":"18.188.135.104","port":58834,"hostname":"ip-172-31-15-96.us-east-2.compute.internal"},{"dns":"18.188.135.104:53413","ip":"18.188.135.104","port":53413,"hostname":"ip-172-31-15-96.us-east-2.compute.internal"},{"dns":"52.14.81.50:61125","ip":"52.14.81.50","port":61125,"hostname":"ip-172-31-3-56.us-east-2.compute.internal"},{"dns":"52.14.81.50:57267","ip":"52.14.81.50","port":57267,"hostname":"ip-172-31-3-56.us-east-2.compute.internal"},{"dns":"52.14.81.50:61886","ip":"52.14.81.50","port":61886,"hostname":"ip-172-31-3-56.us-east-2.compute.internal"},{"dns":"52.14.81.50:57576","ip":"52.14.81.50","port":57576,"hostname":"ip-172-31-3-56.us-east-2.compute.internal"},{"dns":"18.220.129.78:51455","ip":"18.220.129.78","port":51455,"hostname":"ip-172-31-3-218.us-east-2.compute.internal"},{"dns":"18.220.129.78:50617","ip":"18.220.129.78","port":50617,"hostname":"ip-172-31-3-218.us-east-2.compute.internal"},{"dns":"18.220.129.78:61918","ip":"18.220.129.78","port":61918,"hostname":"ip-172-31-3-218.us-east-2.compute.internal"},{"dns":"18.220.129.78:58366","ip":"18.220.129.78","port":58366,"hostname":"ip-172-31-3-218.us-east-2.compute.internal"},{"dns":"18.219.37.136:52024","ip":"18.219.37.136","port":52024,"hostname":"ip-172-31-2-1.us-east-2.compute.internal"},{"dns":"18.219.37.136:51351","ip":"18.219.37.136","port":51351,"hostname":"ip-172-31-2-1.us-east-2.compute.internal"},{"dns":"18.219.37.136:62806","ip":"18.219.37.136","port":62806,"hostname":"ip-172-31-2-1.us-east-2.compute.internal"},{"dns":"18.219.37.136:59571","ip":"18.219.37.136","port":59571,"hostname":"ip-172-31-2-1.us-east-2.compute.internal"},{"dns":"18.191.49.45:51846","ip":"18.191.49.45","port":51846,"hostname":"ip-172-31-13-204.us-east-2.compute.internal"},{"dns":"18.191.49.45:65060","ip":"18.191.49.45","port":65060,"hostname":"ip-172-31-13-204.us-east-2.compute.internal"},{"dns":"18.191.49.45:56460","ip":"18.191.49.45","port":56460,"hostname":"ip-172-31-13-204.us-east-2.compute.internal"},{"dns":"18.191.49.45:54815","ip":"18.191.49.45","port":54815,"hostname":"ip-172-31-13-204.us-east-2.compute.internal"},{"dns":"52.14.212.59:61630","ip":"52.14.212.59","port":61630,"hostname":"ip-172-31-2-81.us-east-2.compute.internal"},{"dns":"52.14.212.59:59848","ip":"52.14.212.59","port":59848,"hostname":"ip-172-31-2-81.us-east-2.compute.internal"},{"dns":"52.14.212.59:60642","ip":"52.14.212.59","port":60642,"hostname":"ip-172-31-2-81.us-east-2.compute.internal"},{"dns":"52.14.212.59:49895","ip":"52.14.212.59","port":49895,"hostname":"ip-172-31-2-81.us-east-2.compute.internal"},{"dns":"18.222.16.255:56946","ip":"18.222.16.255","port":56946,"hostname":"ip-172-31-0-101.us-east-2.compute.internal"},{"dns":"18.222.16.255:60003","ip":"18.222.16.255","port":60003,"hostname":"ip-172-31-0-101.us-east-2.compute.internal"},{"dns":"18.222.16.255:54987","ip":"18.222.16.255","port":54987,"hostname":"ip-172-31-0-101.us-east-2.compute.internal"},{"dns":"18.222.16.255:55607","ip":"18.222.16.255","port":55607,"hostname":"ip-172-31-0-101.us-east-2.compute.internal"}];

    var amounts = [];
    var blocks = [];

    function getbalances() {
      $.each(nodes, function(index, node) {
        // Home server hack
        node.ip = (node.ip == '79.113.115.250') ? '192.168.1.10' : node.ip;

        var balance = 'http://' + node.dns + '/balance';
        var main = 'http://' + node.dns;

        // Other stuff in Rancher
        if (node.ip == '159.89.42.26' || node.ip == '194.102.63.50') {
          return;
        }

        $.ajax({
          dataType: 'json',
          url: balance,
          success: (function(_node, _main) {
            return function(data) {
              amounts.push(data);

              var nodes_healthy = parseInt($('#nodes_healthy').text());
              $('#nodes_healthy').text(nodes_healthy+1);

              $('#sum').html(numeral(ss.sum(amounts)).format('0,0'));
              $('#mean').html(numeral(ss.mean(amounts)).format('0,0'));
              $('#median').html(numeral(ss.medianSorted(amounts)).format('0,0'));

              $.getJSON(_main, function(data2) {
                blocks.push(data2.blocks.length);

                //$('#x').html(numeral(ss.medianAbsoluteDeviation(blocks)).format('0,0'));

                table.row.add([
                  node.hostname,
                  '<a href="' + _main + '" target="_blank">' + _node.ip + ':' + _node.port + '</a>',
                  numeral(data).format('0,0'),
                  numeral(data2.blocks.length).format('0,0')
                ]).draw(false);
              });
            }
          })(node, main),
          timeout: 10000
        })
        .fail((function(_node, _main) {
          return function(xhr, status) {
            console.error(_node, _main);

            table.row.add([
              node.hostname,
              '<a href="' + _main + '" target="_blank">' + _node.ip + ':' + _node.port + '</a>',
              'error',
              'error'
            ]).draw(false);
          }
        })(node, main));
      });
    }

    $(document).ready(function() {
      table = $('#nodes').DataTable({
        'pageLength': 100
      });

      $.getJSON('http://1h3.nodes.webd.hoste.ro:57284/power', function(data) {
        var global_power = parseInt(data.global) / 1000;
        var nodes_available = nodes.length - 2; // two are from other rancher services
        var power = nodes_available * 600 / 1000;
        var block_time = 40;
        var reward_block = 6000;
        var dominance = power / global_power * 100;
        var reward_24 = reward_block * 60 * 60 * 24 / block_time * dominance / 100;
        var reward_24_usd = reward_24 * 0.001;
        var cost_24_usd = 0;
        cost_24_usd += 0.238 * 10 * 24; // do
        cost_24_usd += 0.119 * 20 * 24; // do
        cost_24_usd += 0.808 * 1 * 24; // aws
        cost_24_usd += 0.06 * 20 * 24; // vps

        var roi_24 = reward_24_usd / cost_24_usd * 100;
        var block_mining_time = 100 / dominance * block_time;
        var current_time = new Date();
        current_time = current_time.getHours() + ':' + current_time.getMinutes();

        var real_time = 0;

        setInterval(function() {
          real_time += reward_24 / (3500 * 24) / 1;
          $('#real_time').html(numeral(real_time).format('0,0'));
        }, 1000);

        $('#power').html(numeral(power).format('0,0'));
        $('#global_power').html(numeral(global_power).format('0,0'));
        $('#dominance').html(parseInt(dominance));
        $('#block_time').html(block_time);
        $('#reward_24').html(numeral(reward_24).format('0,0'));
        $('#reward_24_usd').html(numeral(reward_24_usd).format('0,0'));
        $('#roi_24').html(numeral(roi_24).format('0,0'));
        $('#cost_24_usd').html(numeral(cost_24_usd).format('0,0'));
        $('#block_mining_time').html(numeral(block_mining_time).format('0,0'));
        $('#block_mining_time_minutes').html(numeral(block_mining_time / 60).format('0,0'));
        $('#current_time').html(current_time);
        $('#nodes_available').html(numeral(nodes_available).format('0,0'));

        getbalances();
      });
    });
  </script>
</body>

</html>
